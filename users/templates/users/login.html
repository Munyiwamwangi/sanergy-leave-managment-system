{% extends "sanergytemplates/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container" style="padding-top: 200px;">
  <div class="row">
    <div class="col-4"></div>
    <div class="col-4">
      <div class="content-section">
        <div id="google-plus-button">Google+ Sign In</div>
        <form method="POST">
          {% csrf_token %}
          <fieldset class="form-group">
            <legend class="border-bottom mb-4">Log In</legend>
            {{ form|crispy }}
          </fieldset>
          <div class="form-group">
            <button class="btn btn-outline-info" type="submit">Login</button>
            <small class="text-muted ml-2">
              <a href="{% url 'homepage' %}">Forgot Password?</a>
            </small>
          </div>
        </form>
        <div class="border-top pt-3">

        </div>
      </div>
    </div>
    <div class="col-4"></div>
  </div>
</div>
{% block scripts %}
<script src="https://apis.google.com/js/api:client.js"></script>

<script type="text/javascript">
  gapi.load('auth2', function () {
    var auth2;

    auth2 = gapi.auth2.init({
      client_id: "<PUT SOCIAL_AUTH_GOOGLE_PLUS_KEY HERE>",
      scope: "<PUT BACKEND SCOPE HERE>"
    });

    auth2.then(function () {
      var button = document.getElementById("google-plus-button");
      console.log("User is signed-in in Google+ platform?", auth2.isSignedIn.get() ? "Yes" : "No");

      auth2.attachClickHandler(button, {}, function (googleUser) {
        // Send access-token to backend to finish the authenticate
        // with your application

        var authResponse = googleUser.getAuthResponse();
        var $form;
        var $input;

        $form = $("<form>");
        $form.attr("action", "/complete/google-plus");
        $form.attr("method", "post");
        $input = $("<input>");
        $input.attr("name", "id_token");
        $input.attr("value", authResponse.id_token);
        $form.append($input);
        // Add csrf-token if needed
        $(document.body).append($form);
        $form.submit();
      });
    });
  });
</script>
{% endblock %}
{% endblock content %}